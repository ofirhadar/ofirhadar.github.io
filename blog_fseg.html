<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unsupervised Semantic Segmentation with F-Seg</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 40px;
            background-color: #f8f9fa;
            color: #333;
        }
        h1, h2, h3 {
            color: #0056b3;
        }
        pre {
            background: #eee;
            padding: 10px;
            overflow-x: auto;
        }
        code {
            font-family: monospace;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Unsupervised Semantic Segmentation with F-Seg</h1>
        <p>Unsupervised segmentation in digital pathology is a challenging problem. The F-Seg method leverages deep feature factorization (DFF) to extract meaningful concepts from image activations, enabling segmentation without labeled data.</p>
        
        <h2>Deep Feature Factorization (DFF) and Non-Negative Matrix Factorization (NMF)</h2>
        <h3>Theoretical Background</h3>
        <p>Given an input image <code>I</code>, a deep network extracts activation maps <code>A</code> where our goal is to decompose these activations into a set of interpretable components.</p>
        
        <h3>Implementation</h3>
        <pre><code>import numpy as np
import torch
from sklearn.decomposition import NMF

def dff(activations: np.ndarray, n_components: int = 5):
    batch_size, __, h, w = activations.shape
    reshaped_activations = activations.transpose((1, 0, 2, 3)).reshape(activations.shape[1], -1)
    reshaped_activations[np.isnan(reshaped_activations)] = 0
    model = NMF(n_components=n_components, init='random', random_state=0)
    W = model.fit_transform(reshaped_activations)
    H = model.components_.reshape(n_components, batch_size, h, w)
    return W, H.transpose((1, 0, 2, 3))</code></pre>

        <h2>Visualizing Segmentation</h2>
        <pre><code>import matplotlib.pyplot as plt

def show_segmentation_on_image(img: np.uint8, segmentation: np.ndarray, colors=None, image_weight=0.5):
    float_img = np.float32(img) / 255
    n_categories = np.max(segmentation) + 1
    if colors is None:
        cmap = plt.cm.get_cmap('gist_rainbow')
        colors = [np.array(cmap(i)[:3]) for i in np.linspace(0, 1, n_categories)]
    mask = np.zeros_like(float_img)
    for category in range(n_categories):
        mask[segmentation == category] = colors[category]
    return np.uint8((float_img * image_weight + mask * (1 - image_weight)) * 255)</code></pre>

        <h2>F-Seg: From Factorization to Segmentation</h2>
        <h3>Clustering Concepts</h3>
        <p>Once we obtain the matrix <code>W</code>, we cluster the feature vectors into distinct semantic groups.</p>
        
        <h3>Applying F-Seg</h3>
        <pre><code>class FSeg:
    def __init__(self, model, target_layer, reshape_transform=None):
        self.model = model
        self.target_layer = target_layer
        self.reshape_transform = reshape_transform
        self.activations_and_grads = ActivationsAndGradients(self.model, [self.target_layer], self.reshape_transform)
    
    def get_activations(self, input_tensor: torch.tensor) -> np.ndarray:
        with torch.no_grad():
            self.activations_and_grads(input_tensor)
            return self.activations_and_grads.activations[0].cpu().numpy()
    
    def predict_on_single_image(self, input_tensor: torch.tensor, k: int):
        activations = self.get_activations(input_tensor)
        _, w = dff(activations, k)
        segmentation = np.argmax(w[0], axis=0)
        return segmentation</code></pre>
        
        <h2>Conclusion</h2>
        <p>F-Seg enables unsupervised segmentation by leveraging feature factorization. Experiment with different values of <code>k</code> to observe its effect on segmentation granularity!</p>
    </div>
</body>
</html>
